AWSTemplateFormatVersion: "2010-09-09"
Description: A template for creating EC2 instance with security group configured with ssh access
Resources:
    EC2Instance:
      Description: EC2 Linux AMI
      Type: "AWS::EC2::Instance"
      Properties:
        ImageId: "ami-0de53d8956e8dcf80" #This is a Linux AMI
        InstanceType: t2.micro
        KeyName: rgederin-aws-key-pair
        IamInstanceProfile:
          Ref: S3InstanceProfile
        UserData: !Base64
          'Fn::Join':
            - ''
            - - |
                #!/bin/bash -xe
              - |
                aws s3api get-object --bucket rgederin-bucket --key rgederin-s3-file.txt rgederin-s3-file.txt
        SecurityGroups:
          - !Ref SecurityGroup
    SecurityGroup:
        Description: Security group configured for ssh access
        Type: 'AWS::EC2::SecurityGroup'
        Properties:
          GroupDescription: Security Group For EC2
          SecurityGroupIngress:
            - IpProtocol: tcp
              FromPort: 22
              ToPort: 22
              CidrIp: 0.0.0.0/0
    S3InstanceProfile:
      Type: "AWS::IAM::InstanceProfile"
      Properties:
        Path: "/"
        Roles:
          - !Ref S3Role
    S3Policy:
      Type: "AWS::IAM::Policy"
      Properties:
        PolicyName: "S3Policy"
        PolicyDocument:
          Statement:
            Effect: "Allow"
            Action:
              - "s3:*"
            Resource: "*"
        Roles:
          - !Ref S3Role
    S3Role:
      Type: "AWS::IAM::Role"
      Properties:
        AssumeRolePolicyDocument:
          Statement:
            Effect: "Allow"
            Principal:
              Service: "ec2.amazonaws.com"
            Action: "sts:AssumeRole"
        Path: "/"
Outputs:
  PublicIp:
    Description: EC2Instance public IP
    Value: !GetAtt EC2Instance.PublicIp
