{
  "version": 3,
  "sources": ["service-account.ts"],
  "sourcesContent": ["import { AddToPrincipalPolicyResult, IPrincipal, IRole, OpenIdConnectPrincipal, PolicyStatement, PrincipalPolicyFragment, Role } from '../../aws-iam';\nimport { CfnJson, Names } from '../../core';\nimport { Construct } from 'constructs';\nimport { ICluster } from './cluster';\nimport { KubernetesManifest } from './k8s-manifest';\n\n/**\n * Options for `ServiceAccount`\n */\nexport interface ServiceAccountOptions {\n  /**\n   * The name of the service account.\n   * @default - If no name is given, it will use the id of the resource.\n   */\n  readonly name?: string;\n\n  /**\n   * The namespace of the service account.\n   * @default \"default\"\n   */\n  readonly namespace?: string;\n}\n\n/**\n * Properties for defining service accounts\n */\nexport interface ServiceAccountProps extends ServiceAccountOptions {\n  /**\n   * The cluster to apply the patch to.\n   */\n  readonly cluster: ICluster;\n}\n\n/**\n * Service Account\n */\nexport class ServiceAccount extends Construct implements IPrincipal {\n  /**\n   * The role which is linked to the service account.\n   */\n  public readonly role: IRole;\n\n  public readonly assumeRoleAction: string;\n  public readonly grantPrincipal: IPrincipal;\n  public readonly policyFragment: PrincipalPolicyFragment;\n\n  /**\n   * The name of the service account.\n   */\n  public readonly serviceAccountName: string;\n\n  /**\n   * The namespace where the service account is located in.\n   */\n  public readonly serviceAccountNamespace: string;\n\n  constructor(scope: Construct, id: string, props: ServiceAccountProps) {\n    super(scope, id);\n\n    const { cluster } = props;\n    this.serviceAccountName = props.name ?? Names.uniqueId(this).toLowerCase();\n    this.serviceAccountNamespace = props.namespace ?? 'default';\n\n    /* Add conditions to the role to improve security. This prevents other pods in the same namespace to assume the role.\n    * See documentation: https://docs.aws.amazon.com/eks/latest/userguide/create-service-account-iam-policy-and-role.html\n    */\n    const conditions = new CfnJson(this, 'ConditionJson', {\n      value: {\n        [`${cluster.openIdConnectProvider.openIdConnectProviderIssuer}:aud`]: 'sts.amazonaws.com',\n        [`${cluster.openIdConnectProvider.openIdConnectProviderIssuer}:sub`]: `system:serviceaccount:${this.serviceAccountNamespace}:${this.serviceAccountName}`,\n      },\n    });\n    const principal = new OpenIdConnectPrincipal(cluster.openIdConnectProvider).withConditions({\n      StringEquals: conditions,\n    });\n    this.role = new Role(this, 'Role', { assumedBy: principal });\n\n    this.assumeRoleAction = this.role.assumeRoleAction;\n    this.grantPrincipal = this.role.grantPrincipal;\n    this.policyFragment = this.role.policyFragment;\n\n    // Note that we cannot use `cluster.addManifest` here because that would create the manifest\n    // constrct in the scope of the cluster stack, which might be a different stack than this one.\n    // This means that the cluster stack would depend on this stack because of the role,\n    // and since this stack inherintely depends on the cluster stack, we will have a circular dependency.\n    new KubernetesManifest(this, `manifest-${id}ServiceAccountResource`, {\n      cluster,\n      manifest: [{\n        apiVersion: 'v1',\n        kind: 'ServiceAccount',\n        metadata: {\n          name: this.serviceAccountName,\n          namespace: this.serviceAccountNamespace,\n          labels: {\n            'app.kubernetes.io/name': this.serviceAccountName,\n          },\n          annotations: {\n            'eks.amazonaws.com/role-arn': this.role.roleArn,\n          },\n        },\n      }],\n    });\n\n  }\n\n  /**\n   * @deprecated use `addToPrincipalPolicy()`\n   */\n  public addToPolicy(statement: PolicyStatement): boolean {\n    return this.addToPrincipalPolicy(statement).statementAdded;\n  }\n\n  public addToPrincipalPolicy(statement: PolicyStatement): AddToPrincipalPolicyResult {\n    return this.role.addToPrincipalPolicy(statement);\n  }\n}\n"],
  "mappings": "qNAAA,UAAA,QAAA,iBACA,OAAA,QAAA,cACA,aAAA,QAAA,cAEA,eAAA,QAAA,kBAgCA,4BAAoC,cAAA,SAAS,CAoB3C,YAAY,MAAkB,GAAY,MAA0B,WAClE,MAAM,MAAO,2EAEb,KAAM,CAAE,SAAY,MACpB,KAAK,mBAAkB,IAAG,MAAM,QAAI,MAAA,KAAA,OAAA,GAAI,OAAA,MAAM,SAAS,MAAM,cAC7D,KAAK,wBAAuB,IAAG,MAAM,aAAS,MAAA,KAAA,OAAA,GAAI,UAKlD,KAAM,YAAa,GAAI,QAAA,QAAQ,KAAM,gBAAiB,CACpD,MAAO,EACJ,GAAG,QAAQ,sBAAsB,mCAAoC,qBACrE,GAAG,QAAQ,sBAAsB,mCAAoC,yBAAyB,KAAK,2BAA2B,KAAK,wBAGlI,UAAY,GAAI,WAAA,uBAAuB,QAAQ,uBAAuB,eAAe,CACzF,aAAc,aAEhB,KAAK,KAAO,GAAI,WAAA,KAAK,KAAM,OAAQ,CAAE,UAAW,YAEhD,KAAK,iBAAmB,KAAK,KAAK,iBAClC,KAAK,eAAiB,KAAK,KAAK,eAChC,KAAK,eAAiB,KAAK,KAAK,eAMhC,GAAI,gBAAA,mBAAmB,KAAM,YAAY,2BAA4B,CACnE,QACA,SAAU,CAAC,CACT,WAAY,KACZ,KAAM,iBACN,SAAU,CACR,KAAM,KAAK,mBACX,UAAW,KAAK,wBAChB,OAAQ,CACN,yBAA0B,KAAK,oBAEjC,YAAa,CACX,6BAA8B,KAAK,KAAK,cAW3C,YAAY,UAA0B,CAC3C,MAAO,MAAK,qBAAqB,WAAW,eAGvC,qBAAqB,UAA0B,+EAC7C,KAAK,KAAK,qBAAqB,YA7E1C,QAAA,eAAA",
  "names": []
}
