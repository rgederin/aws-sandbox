{
  "version": 3,
  "sources": ["sqs.ts"],
  "sourcesContent": ["import * as iam from '../../aws-iam';\nimport * as s3 from '../../aws-s3';\nimport * as sqs from '../../aws-sqs';\nimport { Annotations } from '../../core';\nimport { Construct } from 'constructs';\n\n/**\n * Use an SQS queue as a bucket notification destination\n */\nexport class SqsDestination implements s3.IBucketNotificationDestination {\n  constructor(private readonly queue: sqs.IQueue) {\n  }\n\n  /**\n   * Allows using SQS queues as destinations for bucket notifications.\n   * Use `bucket.onEvent(event, queue)` to subscribe.\n   */\n  public bind(_scope: Construct, bucket: s3.IBucket): s3.BucketNotificationDestinationConfig {\n    this.queue.grantSendMessages(new iam.ServicePrincipal('s3.amazonaws.com', {\n      conditions: {\n        ArnLike: { 'aws:SourceArn': bucket.bucketArn },\n      },\n    }));\n\n    // if this queue is encrypted, we need to allow S3 to read messages since that's how\n    // it verifies that the notification destination configuration is valid.\n    if (this.queue.encryptionMasterKey) {\n      const statement = new iam.PolicyStatement({\n        principals: [new iam.ServicePrincipal('s3.amazonaws.com')],\n        actions: ['kms:GenerateDataKey*', 'kms:Decrypt'],\n        resources: ['*'],\n      });\n      const addResult = this.queue.encryptionMasterKey.addToResourcePolicy(statement, /* allowNoOp */ true);\n      if (!addResult.statementAdded) {\n        Annotations.of(this.queue.encryptionMasterKey).addWarning(`Can not change key policy of imported kms key. Ensure that your key policy contains the following permissions: \\n${JSON.stringify(statement.toJSON(), null, 2)}`);\n      }\n    }\n\n    return {\n      arn: this.queue.queueArn,\n      type: s3.BucketNotificationDestinationType.QUEUE,\n      dependencies: [this.queue],\n    };\n  }\n\n}\n"],
  "mappings": "qNAAA,IAAA,QAAA,iBACA,GAAA,QAAA,gBAEA,OAAA,QAAA,cAMA,oBAA2B,CACzB,YAA6B,MAAiB,CAAjB,KAAA,MAAA,gEAOtB,KAAK,OAAmB,OAAkB,CAS/C,8DARA,KAAK,MAAM,kBAAkB,GAAI,KAAI,iBAAiB,mBAAoB,CACxE,WAAY,CACV,QAAS,CAAE,gBAAiB,OAAO,eAMnC,KAAK,MAAM,oBAAqB,CAClC,KAAM,WAAY,GAAI,KAAI,gBAAgB,CACxC,WAAY,CAAC,GAAI,KAAI,iBAAiB,qBACtC,QAAS,CAAC,uBAAwB,eAClC,UAAW,CAAC,OAGd,AAAK,AADa,KAAK,MAAM,oBAAoB,oBAAoB,UAA2B,IACjF,gBACb,OAAA,YAAY,GAAG,KAAK,MAAM,qBAAqB,WAAW;EAAoH,KAAK,UAAU,UAAU,SAAU,KAAM,MAI3N,MAAO,CACL,IAAK,KAAK,MAAM,SAChB,KAAM,GAAG,kCAAkC,MAC3C,aAAc,CAAC,KAAK,SAhC1B,QAAA,eAAA",
  "names": []
}
